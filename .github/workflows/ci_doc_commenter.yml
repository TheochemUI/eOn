name: Comment on pull request

on:
  workflow_run:
    workflows: ["Build and Deploy Documentation"]
    types: [completed]

jobs:
  pr_comment:
    if: github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      actions: read

    steps:
      - name: Post link to documentation
        uses: actions/github-script@v7
        env:
          RUN_ID: ${{ github.event.workflow_run.id }}
          REPO_NAME: ${{ github.repository }}
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
        with:
          script: |
            const { RUN_ID, REPO_NAME, HEAD_SHA } = process.env;
            const { owner, repo } = context.repo;

            async function insertUpdateComment(owner, repo, issue_number, purpose, body) {
                const { data: comments } = await github.rest.issues.listComments({
                    owner, repo, issue_number
                });

                // This marker ensures we find our own previous comment to update it
                const marker = ``;
                const finalBody = `${marker}\n${body}`;
                const existing = comments.filter((c) => c.body.includes(marker));

                if (existing.length > 0) {
                    const last = existing[existing.length - 1];
                    core.info(`Updating comment ${last.id}`);
                    await github.rest.issues.updateComment({
                        owner, repo,
                        body: finalBody,
                        comment_id: last.id,
                    });
                } else {
                    core.info(`Creating a new comment in PR #${issue_number}`);
                    await github.rest.issues.createComment({
                        issue_number,
                        body: finalBody,
                        owner,
                        repo
                    });
                }
            }

            // Search for the pull request matching the SHA
            const response = await github.rest.search.issuesAndPullRequests({
                q: `repo:${REPO_NAME} is:pr sha:${HEAD_SHA}`,
                per_page: 1,
            });

            const items = response.data.items;
            if (items.length < 1) {
                return core.error("The search found no matching pull requests.");
            }

            const pullRequestNumber = items[0].number;
            core.info(`Targeting pull request #${pullRequestNumber}`);

            const artifacts = await github.paginate(
                github.rest.actions.listWorkflowRunArtifacts,
                { owner, repo, run_id: RUN_ID }
            );

            const docArtifact = artifacts.find(a => a.name === "documentation");

            if (docArtifact) {
                const link = `https://nightly.link/${owner}/${repo}/actions/artifacts/${docArtifact.id}.zip`;

                let body = `### ðŸ§ª Documentation Preview\n\n`;
                body += `Download the built documentation here: [documentation.zip](${link})\n\n`;
                body += `To view, unzip the file and open \`index.html\` in your browser.`;

                await insertUpdateComment(owner, repo, pullRequestNumber, "link-to-docs", body);
            } else {
                return core.error("The workflow run did not produce a 'documentation' artifact.");
            }
