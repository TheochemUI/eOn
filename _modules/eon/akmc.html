
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>eon.akmc &#8212; eOn</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx_contributors.css?v=f079e67e" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9cb2bd26"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/eon/akmc';</script>
    <link rel="canonical" href="https://eondocs.org/_modules/eon/akmc.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/ev2_trans.png" class="logo__image only-light" alt="eOn - Home"/>
    <script>document.write(`<img src="../../_static/ev2_trans_dark.png" class="logo__image only-dark" alt="eOn - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../team.html">eOn Team</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/index.html">Installation</a></li>


<li class="toctree-l1 has-children"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/akmc.html">AKMC Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/parrep.html">Running a Parallel Replica Job</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../tutorials/CECAM_LTS_MAP_2024/index.html">CECAM Workshop 2024</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/CECAM_LTS_MAP_2024/troubleshooting.html">Virtualbox Troublshooting</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../user_guide/index.html">User Guide</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/lammps_pot.html">LAMMPS Potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/ase_pot.html">ASE Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/metatomic_pot.html">Metatomic Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/mpi_potential.html">MPI Potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/main.html">General Simulation Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/potential.html">Potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/structure_comparison.html">Structure Comparison</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/optimizer.html">Optimizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/minimization.html">Minimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/neb.html">Nudged Elastic Band</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/dimer.html">Dimer method</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/lanczos.html">Lanczos</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/hessian.html">Hessian</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/prefactor.html">Prefactor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/akmc.html">Adaptive Kinetic Monte Carlo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/saddle_search.html">Saddle Search</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/basin_hopping.html">Basin Hopping</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/process_search.html">Process Search</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/recycling.html">Recycling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/coarse_graining.html">Coarse Graining</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/dynamics.html">Dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/parallel_replica.html">Parallel Replica</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/hyperdynamics.html">Hyperdynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/communicator.html">Communicator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/debug.html">Debug</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/paths.html">Paths</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_guide/kdb.html">Kinetic Database</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../devdocs/index.html">Development Documentation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../devdocs/testing.html">Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../devdocs/docbuild.html">Working with the documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../devdocs/svn.html">Subversion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../devdocs/svn-migration.html">Migrating from SVN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../devdocs/tracking-changes.html">Tracking changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../devdocs/release.html">Checklist</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../apidocs/index.html">API Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../apidocs/eon/eon.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon</span></code></a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../apidocs/eon/eon.mcamc.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.mcamc</span></code></a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../apidocs/eon/eon.mcamc.test.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.mcamc.test</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../apidocs/eon/eon.mcamc.mcamc.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.mcamc.mcamc</span></code></a></li>
</ul>
</details></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.parallelreplica.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.parallelreplica</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.eon_kdb.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.eon_kdb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.escaperate.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.escaperate</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.server.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.server</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.communicator.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.communicator</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.mpiwait.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.mpiwait</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.basinhopping.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.basinhopping</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.akmcstate.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.akmcstate</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.superbasin.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.superbasin</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.prstate.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.prstate</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.atoms.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.atoms</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.state.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.state</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.locking.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.locking</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.explorer.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.explorer</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.recycling.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.recycling</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.superbasinscheme.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.superbasinscheme</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.movie.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.movie</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.askmc.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.askmc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.config.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.config</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.statelist.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.statelist</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.prstatelist.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.prstatelist</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.fileio.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.fileio</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.displace.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.displace</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.akmc.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.akmc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../apidocs/eon/eon.akmcstatelist.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">eon.akmcstatelist</span></code></a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../releases/index.html">Releases</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../releases/changelog.html">Changelog</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../releases/v2.8.0/index.html">[v2.8.0] - 2025-09-04</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v2.8.0/release-notes.html">Release notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v2.8.0/publications.html">Related Publications</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../releases/v2.8.1/index.html">[v2.8.1] - 2025-11-03</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v2.8.1/release-notes.html">Release notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v2.8.1/publications.html">Related Publications</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../releases/v2.8.2/index.html">[v2.8.2] - 2025-12-01</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../releases/v2.8.2/release-notes.html">Release notes</a></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/TheochemUI/eOn" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for eon.akmc</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">configparser</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">unix_time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">optparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging.handlers</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;akmc&#39;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">builtins</span><span class="w"> </span><span class="kn">import</span> <span class="nb">input</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">,</span> <span class="n">over</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">,</span> <span class="n">under</span><span class="o">=</span><span class="s2">&quot;print&quot;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">eon.version</span><span class="w"> </span><span class="kn">import</span> <span class="n">version</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">eon.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">EON_CONFIG</span> <span class="c1"># NOTE: Since it is a global object..</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">eon.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigClass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">eon</span><span class="w"> </span><span class="kn">import</span> <span class="n">communicator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">eon</span><span class="w"> </span><span class="kn">import</span> <span class="n">locking</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">eon</span><span class="w"> </span><span class="kn">import</span> <span class="n">akmcstatelist</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">eon</span><span class="w"> </span><span class="kn">import</span> <span class="n">explorer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">eon</span><span class="w"> </span><span class="kn">import</span> <span class="n">fileio</span> <span class="k">as</span> <span class="n">io</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">eon</span><span class="w"> </span><span class="kn">import</span> <span class="n">atoms</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">eon</span><span class="w"> </span><span class="kn">import</span> <span class="n">superbasinscheme</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">eon</span><span class="w"> </span><span class="kn">import</span> <span class="n">askmc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">eon</span><span class="w"> </span><span class="kn">import</span> <span class="n">movie</span>

<div class="viewcode-block" id="akmc">
<a class="viewcode-back" href="../../apidocs/eon/eon.akmc.html#eon.akmc.akmc">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">akmc</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">ConfigClass</span> <span class="o">=</span> <span class="n">EON_CONFIG</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Poll for status of AKMC clients and possibly make KMC steps.</span>

<span class="sd">    Returns the number of KMC steps in the current run at the end of</span>
<span class="sd">    this function. The argument &quot;steps&quot; gives the number of KMC steps</span>
<span class="sd">    done before calling this function, defaulting to zero.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#log version information</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Eon version </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
    <span class="c1"># Here&#39;s what this does:</span>
    <span class="c1"># 1) Read in the state of our calculation from last time</span>
    <span class="c1"># 2) Initialize necessary data structures (statelist, communicator, displace)</span>
    <span class="c1"># 3) Get any results that have come in</span>
    <span class="c1"># 4) Possibly take a KMC step</span>
    <span class="c1"># 5) Make new work units</span>
    <span class="c1"># 6) Write out the state of the simulation</span>

    <span class="c1"># First of all, does the root directory even exist?</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_root</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Root directory does not exist, as such the &quot;</span> \
                        <span class="s2">&quot;reactant cannot exist. Exiting...&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># If we are saving debug results, create the directory if it does not exist.</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">debug_keep_all_results</span><span class="p">:</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">debug_results_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">rp</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span>

    <span class="c1"># Define constants.</span>
    <span class="n">kT</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">main_temperature</span><span class="o">/</span><span class="mf">11604.5</span> <span class="c1">#in eV</span>

    <span class="c1"># Load metadata, the state list, and the current state.</span>
    <span class="n">start_state_num</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">previous_state_num</span><span class="p">,</span> <span class="n">first_run</span><span class="p">,</span> <span class="n">previous_temperature</span> <span class="o">=</span> <span class="n">get_akmc_metadata</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">first_run</span><span class="p">:</span>
        <span class="n">previous_temperature</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">main_temperature</span>

    <span class="c1"># Did the temperature change? Then the existing superbasins are invalid now.</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">previous_temperature</span> <span class="o">-</span> <span class="n">config</span><span class="o">.</span><span class="n">main_temperature</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
        <span class="c1"># Remove superbasin data.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sb_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sb_path</span><span class="p">)</span>
        <span class="n">state_dirs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_states</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">state_dir</span> <span class="ow">in</span> <span class="n">state_dirs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state_dir</span> <span class="o">==</span> <span class="s1">&#39;state_table&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">superbasin_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_states</span><span class="p">,</span> <span class="n">state_dir</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_state_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">superbasin_file</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">superbasin_file</span><span class="p">)</span>
        <span class="c1"># Keep the new temperature.</span>
        <span class="n">previous_temperature</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">main_temperature</span>

    <span class="n">states</span> <span class="o">=</span> <span class="n">get_statelist</span><span class="p">(</span><span class="n">kT</span><span class="p">)</span>
    <span class="n">current_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">get_state</span><span class="p">(</span><span class="n">start_state_num</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">previous_state_num</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">previous_state</span> <span class="o">=</span> <span class="n">current_state</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">previous_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">get_state</span><span class="p">(</span><span class="n">previous_state_num</span><span class="p">)</span>
    <span class="c1"># If the Novotny-based superbasining scheme is being used, initialize it.</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_on</span><span class="p">:</span>
        <span class="n">superbasining</span> <span class="o">=</span> <span class="n">get_superbasin_scheme</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">sb</span> <span class="o">=</span> <span class="n">superbasining</span><span class="o">.</span><span class="n">get_containing_superbasin</span><span class="p">(</span><span class="n">current_state</span><span class="p">)</span>
        <span class="c1"># If we are exploring states in a superbasin, we will always</span>
        <span class="c1"># explore the state with the lowest confidence.</span>
        <span class="k">if</span> <span class="n">sb</span><span class="p">:</span>
            <span class="n">explore_state</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="n">get_lowest_confidence_state</span><span class="p">()</span>
            <span class="n">previous_state</span> <span class="o">=</span> <span class="n">explore_state</span> <span class="c1"># TODO: perhaps there is a better value for previous_state?</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">explore_state</span> <span class="o">=</span> <span class="n">current_state</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">superbasining</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">explore_state</span> <span class="o">=</span> <span class="n">current_state</span>

    <span class="n">state_explorer</span> <span class="o">=</span> <span class="n">explorer</span><span class="o">.</span><span class="n">get_minmodexplorer</span><span class="p">()(</span><span class="n">states</span><span class="p">,</span> <span class="n">previous_state</span><span class="p">,</span> <span class="n">explore_state</span><span class="p">,</span> <span class="n">superbasin</span><span class="o">=</span><span class="n">sb</span><span class="p">)</span>
    <span class="n">state_explorer</span><span class="o">.</span><span class="n">explore</span><span class="p">()</span>

    <span class="c1"># Take a KMC step, if it&#39;s time.</span>
    <span class="n">current_state</span><span class="p">,</span> <span class="n">previous_state</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">steps</span> <span class="o">=</span> <span class="n">kmc_step</span><span class="p">(</span><span class="n">current_state</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">kT</span><span class="p">,</span> <span class="n">superbasining</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>

    <span class="c1"># Write out metadata.</span>
    <span class="n">metafile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="s1">&#39;info.txt&#39;</span><span class="p">)</span>
<span class="c1">#    parser = configparser.RawConfigParser()</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">previous_state</span><span class="o">.</span><span class="n">number</span> <span class="o">!=</span> <span class="n">current_state</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
        <span class="n">previous_state_num</span> <span class="o">=</span> <span class="n">previous_state</span><span class="o">.</span><span class="n">number</span>

    <span class="n">write_akmc_metadata</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">current_state</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">previous_state_num</span><span class="p">,</span> <span class="n">previous_temperature</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">metafile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">))</span>

    <span class="n">io</span><span class="o">.</span><span class="n">save_prng_state</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">steps</span></div>


<div class="viewcode-block" id="get_akmc_metadata">
<a class="viewcode-back" href="../../apidocs/eon/eon.akmc.html#eon.akmc.get_akmc_metadata">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_akmc_metadata</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">ConfigClass</span> <span class="o">=</span> <span class="n">EON_CONFIG</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_results</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_results</span><span class="p">)</span>
    <span class="c1"># read in metadata</span>
    <span class="c1"># do we want custom metadata locations?</span>
    <span class="n">metafile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="s1">&#39;info.txt&#39;</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">ini</span><span class="p">(</span><span class="n">metafile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metafile</span><span class="p">):</span>
        <span class="n">start_state_num</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Simulation Information&quot;</span><span class="p">,</span><span class="s1">&#39;current_state&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Simulation Information&quot;</span><span class="p">,</span> <span class="s1">&#39;time_simulated&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">previous_state_num</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Simulation Information&quot;</span><span class="p">,</span> <span class="s2">&quot;previous_state&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">previous_temperature</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Simulation Information&quot;</span><span class="p">,</span> <span class="s2">&quot;previous_temperature&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">first_run</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Simulation Information&quot;</span><span class="p">,</span> <span class="s2">&quot;first_run&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start_state_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">previous_state_num</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">first_run</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">previous_temperature</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">main_temperature</span>

    <span class="k">return</span> <span class="n">start_state_num</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">previous_state_num</span><span class="p">,</span> <span class="n">first_run</span><span class="p">,</span> <span class="n">previous_temperature</span></div>


<div class="viewcode-block" id="write_akmc_metadata">
<a class="viewcode-back" href="../../apidocs/eon/eon.akmc.html#eon.akmc.write_akmc_metadata">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_akmc_metadata</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">current_state_num</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">previous_state_num</span><span class="p">,</span> <span class="n">previous_temperature</span><span class="p">):</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;aKMC Metadata&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;Simulation Information&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;Simulation Information&#39;</span><span class="p">,</span> <span class="s1">&#39;time_simulated&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;Simulation Information&#39;</span><span class="p">,</span> <span class="s1">&#39;current_state&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_state_num</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;Simulation Information&#39;</span><span class="p">,</span> <span class="s1">&#39;previous_state&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">previous_state_num</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;Simulation Information&#39;</span><span class="p">,</span> <span class="s1">&#39;first_run&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;Simulation Information&#39;</span><span class="p">,</span> <span class="s1">&#39;previous_temperature&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">previous_temperature</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_statelist">
<a class="viewcode-back" href="../../apidocs/eon/eon.akmc.html#eon.akmc.get_statelist">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_statelist</span><span class="p">(</span><span class="n">kT</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigClass</span> <span class="o">=</span> <span class="n">EON_CONFIG</span><span class="p">):</span>
    <span class="n">initial_state_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="s2">&quot;pos.con&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">akmcstatelist</span><span class="o">.</span><span class="n">AKMCStateList</span><span class="p">(</span>
        <span class="n">kT</span><span class="p">,</span>
        <span class="n">config</span><span class="o">.</span><span class="n">akmc_thermal_window</span><span class="p">,</span>
        <span class="n">config</span><span class="o">.</span><span class="n">akmc_max_thermal_window</span><span class="p">,</span>
        <span class="n">initial_state_path</span><span class="p">,</span>
        <span class="n">filter_hole</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">disp_moved_only</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="get_superbasin_scheme">
<a class="viewcode-back" href="../../apidocs/eon/eon.akmc.html#eon.akmc.get_superbasin_scheme">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_superbasin_scheme</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_scheme</span> <span class="o">==</span> <span class="s1">&#39;transition_counting&#39;</span><span class="p">:</span>
        <span class="n">superbasining</span> <span class="o">=</span> <span class="n">superbasinscheme</span><span class="o">.</span><span class="n">TransitionCounting</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sb_path</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">main_temperature</span> <span class="o">/</span> <span class="mf">11604.5</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_tc_ntrans</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_scheme</span> <span class="o">==</span> <span class="s1">&#39;energy_level&#39;</span><span class="p">:</span>
        <span class="n">superbasining</span> <span class="o">=</span> <span class="n">superbasinscheme</span><span class="o">.</span><span class="n">EnergyLevel</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sb_path</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">main_temperature</span> <span class="o">/</span> <span class="mf">11604.5</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_el_energy_increment</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_scheme</span> <span class="o">==</span> <span class="s1">&#39;rate&#39;</span><span class="p">:</span>
        <span class="n">superbasining</span> <span class="o">=</span> <span class="n">superbasinscheme</span><span class="o">.</span><span class="n">RateThreshold</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sb_path</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">main_temperature</span> <span class="o">/</span> <span class="mf">11604.5</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_rt_rate_threshold</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">superbasining</span></div>



<div class="viewcode-block" id="kmc_step">
<a class="viewcode-back" href="../../apidocs/eon/eon.akmc.html#eon.akmc.kmc_step">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">kmc_step</span><span class="p">(</span><span class="n">current_state</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">kT</span><span class="p">,</span> <span class="n">superbasining</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ConfigClass</span> <span class="o">=</span> <span class="n">EON_CONFIG</span><span class="p">):</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">unix_time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">previous_state</span> <span class="o">=</span> <span class="n">current_state</span>
    <span class="c1"># If the Chatterjee &amp; Voter superbasin acceleration method is being used</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">askmc_on</span><span class="p">:</span>
        <span class="n">pass_rec_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">asKMC</span> <span class="o">=</span> <span class="n">askmc</span><span class="o">.</span><span class="n">ASKMC</span><span class="p">(</span><span class="n">kT</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">askmc_confidence</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">askmc_alpha</span><span class="p">,</span>
                            <span class="n">config</span><span class="o">.</span><span class="n">askmc_gamma</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">askmc_barrier_test_on</span><span class="p">,</span>
                            <span class="n">config</span><span class="o">.</span><span class="n">askmc_connections_test_on</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_recycling_on</span><span class="p">,</span>
                            <span class="n">config</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">akmc_thermal_window</span><span class="p">,</span>
                            <span class="n">recycle_path</span> <span class="o">=</span> <span class="n">pass_rec_path</span><span class="p">)</span>

    <span class="c1"># The system might be in a superbasin</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_on</span><span class="p">:</span>
        <span class="n">sb</span> <span class="o">=</span> <span class="n">superbasining</span><span class="o">.</span><span class="n">get_containing_superbasin</span><span class="p">(</span><span class="n">current_state</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sb</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">while</span> <span class="p">((</span>
            <span class="p">(</span><span class="ow">not</span> <span class="n">sb</span> <span class="ow">and</span> <span class="n">current_state</span><span class="o">.</span><span class="n">get_confidence</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">config</span><span class="o">.</span><span class="n">akmc_confidence</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">sb</span> <span class="ow">and</span> <span class="n">sb</span><span class="o">.</span><span class="n">get_confidence</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">config</span><span class="o">.</span><span class="n">akmc_confidence</span><span class="p">)</span>
           <span class="p">)</span> <span class="ow">and</span>
           <span class="p">(</span><span class="n">steps</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">.</span><span class="n">akmc_max_kmc_steps</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">akmc_max_kmc_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>

        <span class="c1"># Do a KMC step.</span>
        <span class="n">steps</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_on</span> <span class="ow">and</span> <span class="n">sb</span><span class="p">:</span>
            <span class="n">mean_time</span><span class="p">,</span> <span class="n">current_state</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">sb_proc_id_out</span><span class="p">,</span> <span class="n">sb_id</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">current_state</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">get_product_state</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">askmc_on</span><span class="p">:</span>
                <span class="n">rate_table</span> <span class="o">=</span> <span class="n">asKMC</span><span class="o">.</span><span class="n">get_ratetable</span><span class="p">(</span><span class="n">current_state</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rate_table</span> <span class="o">=</span> <span class="n">current_state</span><span class="o">.</span><span class="n">get_ratetable</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rate_table</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No processes in rate table, but confidence &quot;</span>
                             <span class="s2">&quot;has been reached&quot;</span><span class="p">)</span>

            <span class="n">ratesum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rate_table</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>

            <span class="n">u</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span>
            <span class="n">p</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">nsid</span> <span class="o">=</span> <span class="mf">1.1</span> <span class="c1"># Next state process id, will throw exception if remains unchanged.</span>

            <span class="c1"># If we are following another trajectory:</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">debug_target_trajectory</span> <span class="o">!=</span> <span class="s2">&quot;False&quot;</span><span class="p">:</span>
                <span class="c1"># Get the Dynamics objects.</span>
                <span class="n">owndynamics</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">Dynamics</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="s2">&quot;dynamics.txt&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">targetdynamics</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">Dynamics</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">debug_target_trajectory</span><span class="p">,</span> <span class="s2">&quot;dynamics.txt&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="c1"># Get the current_step.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">current_step</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">owndynamics</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">current_step</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># Get the target step process id.</span>
                <span class="k">if</span> <span class="n">current_step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">stateid</span> <span class="o">=</span> <span class="n">targetdynamics</span><span class="p">[</span><span class="n">current_step</span><span class="p">][</span><span class="s1">&#39;reactant&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stateid</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">procid</span> <span class="o">=</span> <span class="n">targetdynamics</span><span class="p">[</span><span class="n">current_step</span><span class="p">][</span><span class="s1">&#39;process&#39;</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can no longer follow target trajectory&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Load the con file for that process saddle.</span>
                <span class="n">targetSaddleCon</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">loadcon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">debug_target_trajectory</span><span class="p">,</span> <span class="s2">&quot;states&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">stateid</span><span class="p">),</span> <span class="s2">&quot;procdata&quot;</span><span class="p">,</span> <span class="s2">&quot;saddle_</span><span class="si">%d</span><span class="s2">.con&quot;</span> <span class="o">%</span> <span class="n">procid</span><span class="p">))</span>
                <span class="n">targetProductCon</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">loadcon</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">debug_target_trajectory</span><span class="p">,</span> <span class="s2">&quot;states&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">stateid</span><span class="p">),</span> <span class="s2">&quot;procdata&quot;</span><span class="p">,</span> <span class="s2">&quot;product_</span><span class="si">%d</span><span class="s2">.con&quot;</span> <span class="o">%</span> <span class="n">procid</span><span class="p">))</span>
                <span class="n">ibox</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">targetSaddleCon</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>
                <span class="c1"># See if we have this process</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rate_table</span><span class="p">)):</span>
                    <span class="n">p1</span> <span class="o">=</span> <span class="n">current_state</span><span class="o">.</span><span class="n">get_process_saddle</span><span class="p">(</span><span class="n">rate_table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">per_atom_norm_gen</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">free_r</span><span class="p">()</span> <span class="o">-</span> <span class="n">targetSaddleCon</span><span class="o">.</span><span class="n">free_r</span><span class="p">(),</span> <span class="n">targetSaddleCon</span><span class="o">.</span><span class="n">box</span><span class="p">,</span> <span class="n">ibox</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">comp_eps_r</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">p1</span> <span class="o">=</span> <span class="n">current_state</span><span class="o">.</span><span class="n">get_process_product</span><span class="p">(</span><span class="n">rate_table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">per_atom_norm_gen</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">free_r</span><span class="p">()</span> <span class="o">-</span> <span class="n">targetProductCon</span><span class="o">.</span><span class="n">free_r</span><span class="p">(),</span> <span class="n">targetProductCon</span><span class="o">.</span><span class="n">box</span><span class="p">,</span> <span class="n">ibox</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">comp_eps_r</span><span class="p">:</span>
                                <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">nsid</span> <span class="o">=</span> <span class="n">i</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can no longer follow target trajectory&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># We are not following another trajectory:</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rate_table</span><span class="p">):</span>
                    <span class="n">p</span> <span class="o">+=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">ratesum</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">&gt;</span><span class="n">u</span><span class="p">:</span>
                        <span class="n">nsid</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Warning: Failed to select rate; p = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                    <span class="k">break</span>

            <span class="n">next_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">get_product_state</span><span class="p">(</span><span class="n">current_state</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">rate_table</span><span class="p">[</span><span class="n">nsid</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">mean_time</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">ratesum</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Meantime for Step &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;: &quot;</span><span class="p">,</span> <span class="n">mean_time</span><span class="p">)</span>
        <span class="c1"># Accounting for time</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">debug_use_mean_time</span><span class="p">:</span>
            <span class="n">step_time</span> <span class="o">=</span> <span class="n">mean_time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#numpy.random.random_sample() uses [0,1)</span>
            <span class="c1">#which could produce issues with math.log()</span>
            <span class="n">step_time</span> <span class="o">=</span> <span class="o">-</span><span class="n">mean_time</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">())</span>

        <span class="n">time</span> <span class="o">+=</span> <span class="n">step_time</span>

        <span class="c1"># Pass transition information to extension schemes</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">askmc_on</span><span class="p">:</span>
            <span class="n">asKMC</span><span class="o">.</span><span class="n">register_transition</span><span class="p">(</span><span class="n">current_state</span><span class="p">,</span> <span class="n">next_state</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_on</span><span class="p">:</span>
            <span class="n">superbasining</span><span class="o">.</span><span class="n">register_transition</span><span class="p">(</span><span class="n">current_state</span><span class="p">,</span> <span class="n">next_state</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_on</span> <span class="ow">and</span> <span class="n">sb</span><span class="p">:</span>
            <span class="n">proc_id_out</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proc_id_out</span> <span class="o">=</span> <span class="n">rate_table</span><span class="p">[</span><span class="n">nsid</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Write data to disk</span>
        <span class="n">dynamics</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">Dynamics</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="s2">&quot;dynamics.txt&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">proc_id_out</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">current_state</span><span class="o">.</span><span class="n">get_process</span><span class="p">(</span><span class="n">proc_id_out</span><span class="p">)</span>
            <span class="n">dynamics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_state</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">proc_id_out</span><span class="p">,</span> <span class="n">next_state</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">step_time</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">proc</span><span class="p">[</span><span class="s1">&#39;barrier&#39;</span><span class="p">],</span> <span class="n">proc</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">],</span> <span class="n">current_state</span><span class="o">.</span><span class="n">get_energy</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;KMC step from state </span><span class="si">%i</span><span class="s2"> through process </span><span class="si">%i</span><span class="s2"> to state </span><span class="si">%i</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">current_state</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">rate_table</span><span class="p">[</span><span class="n">nsid</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">next_state</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#XXX The proc_out_id was -1, which means there&#39;s a bug or this was a superbasin step.</span>
            <span class="n">dynamics</span><span class="o">.</span><span class="n">append_sb</span><span class="p">(</span><span class="n">current_state</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">sb_proc_id_out</span><span class="p">,</span> <span class="n">next_state</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">step_time</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">sb_id</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">mean_time</span><span class="p">,</span> <span class="n">current_state</span><span class="o">.</span><span class="n">get_energy</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SB step from state </span><span class="si">%i</span><span class="s2"> through process </span><span class="si">%i</span><span class="s2"> to state </span><span class="si">%i</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">current_state</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">sb_proc_id_out</span><span class="p">,</span> <span class="n">next_state</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>

        <span class="c1">#criterion used to stop the job: currently an energy limit is used as criterion</span>
        <span class="k">if</span> <span class="n">current_state</span><span class="o">.</span><span class="n">get_energy</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">debug_stop_criterion</span><span class="p">:</span>
           <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="n">previous_state</span> <span class="o">=</span> <span class="n">current_state</span>
        <span class="n">current_state</span> <span class="o">=</span> <span class="n">next_state</span>

        <span class="c1"># The system might be in a superbasin</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_on</span><span class="p">:</span>
            <span class="n">sb</span> <span class="o">=</span> <span class="n">superbasining</span><span class="o">.</span><span class="n">get_containing_superbasin</span><span class="p">(</span><span class="n">current_state</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sb</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_on</span><span class="p">:</span>
        <span class="n">superbasining</span><span class="o">.</span><span class="n">write_data</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">sb</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Currently in state </span><span class="si">%i</span><span class="s2"> with confidence </span><span class="si">%.6f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">current_state</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                    <span class="n">current_state</span><span class="o">.</span><span class="n">get_confidence</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Currently in state </span><span class="si">%i</span><span class="s2"> (superbasin </span><span class="si">%i</span><span class="s2">) with confidence </span><span class="si">%.6f</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">current_state</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                    <span class="n">sb</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">sb</span><span class="o">.</span><span class="n">get_confidence</span><span class="p">())</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">unix_time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;KMC finished in </span><span class="si">%.4f</span><span class="s2"> seconds&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2"> KMC steps per second&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">current_state</span><span class="p">,</span> <span class="n">previous_state</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">steps</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../apidocs/eon/eon.akmc.html#eon.akmc.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">ConfigClass</span> <span class="o">=</span> <span class="n">EON_CONFIG</span><span class="p">):</span>
    <span class="n">optpar</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span> <span class="o">=</span> <span class="s2">&quot;usage: %prog [options] config.ini&quot;</span><span class="p">)</span>
    <span class="n">optpar</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-C&quot;</span><span class="p">,</span> <span class="s2">&quot;--continuous&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;continuous&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;don&#39;t quit&quot;</span><span class="p">)</span>
    <span class="n">optpar</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-R&quot;</span><span class="p">,</span> <span class="s2">&quot;--reset&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;reset the aKMC simulation, discarding all data&quot;</span><span class="p">)</span>
    <span class="n">optpar</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;--force&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;force&quot;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;force a reset, no questions asked&quot;</span><span class="p">)</span>
    <span class="n">optpar</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="s2">&quot;--restart&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;restart&quot;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;restart the aKMC simulations from a clean dynamics.txt file&quot;</span><span class="p">)</span>
    <span class="n">optpar</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="s2">&quot;--status&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;print_status&quot;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;print the status of the simulation and currently running jobs&quot;</span><span class="p">)</span>
    <span class="n">optpar</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="s2">&quot;--quiet&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;quiet&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;only write to the log file&quot;</span><span class="p">)</span>
    <span class="n">optpar</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;--movie&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;movie_type&quot;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify the type of movie to make [dynamics, states, fastestpath, fastestfullpath, graph, processes]. Process movies are specified like so: --movie processes,statenumber,processlimit. Where processes is the string processes, statenumber is the number of the state that you want to view, and process limit is the maximum number of processes you would like in the movie. The returned processes are reverse sorted by rate such that the fastest processes is the first in the movie.&quot;</span><span class="p">)</span>
    <span class="n">optpar</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-M&quot;</span><span class="p">,</span> <span class="s2">&quot;--separate-movie-files&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;separate_movie_files&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not write the movie into a single file but use a separate POSCAR for every state. These are created in the </span><span class="se">\&quot;</span><span class="s2">movies</span><span class="se">\&quot;</span><span class="s2"> directory. Only useful in conjunction with --movie.&quot;</span><span class="p">)</span>
    <span class="n">optpar</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="s2">&quot;--no-submit&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;no_submit&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;don&#39;t submit searches; only register finished results&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">optpar</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;akmc.py takes only one positional argument&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">+=</span> <span class="n">args</span>
        <span class="c1">#always run from the directory where the config file is</span>
        <span class="c1">#os.chdir(os.path.dirname(args[0]))</span>

    <span class="c1">#XXX: config is ugly as it finds out where the config file is directly from</span>
    <span class="c1">#     sys.argv instead of being passed it.</span>
    <span class="c1">#import sys</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
    <span class="c1">#set options.path_root to be where the config file is if given as an arg</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">path_root</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">path_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_root</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">no_submit</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">comm_job_buffer_size</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">#setup logging</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="s2">&quot;akmc.log&quot;</span><span class="p">),</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(levelname)s</span><span class="s2">:</span><span class="si">%(name)s</span><span class="s2">: </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">datefmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%F</span><span class="s2"> %T&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">raiseExceptions</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="n">rootlogger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">console</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="n">console</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">console</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="n">rootlogger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>

    <span class="n">lock</span> <span class="o">=</span> <span class="n">locking</span><span class="o">.</span><span class="n">LockFile</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="n">config</span><span class="o">.</span><span class="n">path_results</span> <span class="o">/</span> <span class="s2">&quot;lockfile&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()))</span>

    <span class="c1"># Some options are mutually exclusive. Let&#39;s check them now.</span>
    <span class="n">exclusive_options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">movie_type</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">exclusive_options</span><span class="p">[</span><span class="s1">&#39;movie_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exclusive_options</span><span class="p">[</span><span class="s1">&#39;movie_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">exclusive_options</span><span class="p">[</span><span class="s1">&#39;print_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">print_status</span>
    <span class="n">exclusive_options</span><span class="p">[</span><span class="s1">&#39;reset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">reset</span>

    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">exclusive_options</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">offending_options</span> <span class="o">=</span> <span class="p">[</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">exclusive_options</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span> <span class="n">v</span> <span class="p">]</span>
        <span class="n">optpar</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Options </span><span class="si">%s</span><span class="s2"> are mutually exclusive&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">offending_options</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">movie_type</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">get_statelist</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">main_temperature</span> <span class="o">/</span> <span class="mf">11604.5</span><span class="p">)</span>
        <span class="n">movie</span><span class="o">.</span><span class="n">make_movie</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">movie_type</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span>
                         <span class="n">options</span><span class="o">.</span><span class="n">separate_movie_files</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># From the config file: The Novotny and C&amp;V (ASKMC) methods should not be used together.</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_on</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">askmc_on</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Both superbasin methods should not be used at the same time&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># From the config file: dynamics confidence can not be used with MinMode searches</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">saddle_method</span><span class="o">==</span><span class="s2">&quot;min_mode&quot;</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">akmc_confidence_scheme</span><span class="o">==</span><span class="s2">&quot;dynamics&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Dynamics confidence scheme can not be used with MinMode saddle searches&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">print_status</span><span class="p">:</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">get_statelist</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">main_temperature</span> <span class="o">/</span> <span class="mf">11604.5</span><span class="p">)</span>
        <span class="n">start_state_num</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">previous_state_num</span><span class="p">,</span> <span class="n">first_run</span><span class="p">,</span> <span class="n">previous_temperature</span> <span class="o">=</span>\
            <span class="n">get_akmc_metadata</span><span class="p">()</span>
        <span class="n">current_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">get_state</span><span class="p">(</span><span class="n">start_state_num</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_on</span><span class="p">:</span>
            <span class="n">sb_scheme</span> <span class="o">=</span> <span class="n">get_superbasin_scheme</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
            <span class="n">sb</span> <span class="o">=</span> <span class="n">sb_scheme</span><span class="o">.</span><span class="n">get_containing_superbasin</span><span class="p">(</span><span class="n">current_state</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;General&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sb</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current state:&quot;</span><span class="p">,</span> <span class="n">start_state_num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current state:&quot;</span><span class="p">,</span> <span class="n">start_state_num</span><span class="p">,</span> <span class="s2">&quot;in superbasin&quot;</span><span class="p">,</span> <span class="n">sb</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of states:&quot;</span><span class="p">,</span><span class="n">states</span><span class="o">.</span><span class="n">get_num_states</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time simulated: </span><span class="si">%.3e</span><span class="s2"> seconds&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current State&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------------&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sb</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Confidence: </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">current_state</span><span class="o">.</span><span class="n">get_confidence</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Superbasin Confidence: </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sb</span><span class="o">.</span><span class="n">get_confidence</span><span class="p">())</span>
            <span class="n">non_ignored_states</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sb</span><span class="o">.</span><span class="n">_get_filtered_states</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sb</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">non_ignored_states</span><span class="p">:</span>
                    <span class="n">ignore_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ignore_string</span> <span class="o">=</span> <span class="s2">&quot; (no exit from superbasin found)&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;       </span><span class="si">%4i</span><span class="s2">: </span><span class="si">%.4f%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">get_confidence</span><span class="p">(</span><span class="n">sb</span><span class="p">),</span> <span class="n">ignore_string</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unique Saddles:&quot;</span><span class="p">,</span> <span class="n">current_state</span><span class="o">.</span><span class="n">get_unique_saddle_count</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Good Saddles:&quot;</span><span class="p">,</span> <span class="n">current_state</span><span class="o">.</span><span class="n">get_good_saddle_count</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bad Saddles:&quot;</span><span class="p">,</span> <span class="n">current_state</span><span class="o">.</span><span class="n">get_bad_saddle_count</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Percentage bad saddles: </span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">current_state</span><span class="o">.</span><span class="n">get_bad_saddle_count</span><span class="p">())</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">current_state</span><span class="o">.</span><span class="n">get_bad_saddle_count</span><span class="p">()</span> <span class="o">+</span> <span class="n">current_state</span><span class="o">.</span><span class="n">get_good_saddle_count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>

        <span class="n">comm</span> <span class="o">=</span> <span class="n">communicator</span><span class="o">.</span><span class="n">get_communicator</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saddle Searches&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Searches in queue:&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="o">.</span><span class="n">get_queue_size</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_on</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Superbasins&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sb_scheme</span><span class="o">.</span><span class="n">superbasins</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">state_numbers</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">reset</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Are you sure you want to reset (all data files will be lost)? (y/N) &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">attempt_removal</span><span class="p">(</span><span class="n">thing</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">thing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">thing</span><span class="p">):</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">removedirs</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">thing</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
                <span class="n">rmthings</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">path_jobs_out</span><span class="p">,</span>
                            <span class="n">config</span><span class="o">.</span><span class="n">path_jobs_in</span><span class="p">,</span>
                            <span class="n">config</span><span class="o">.</span><span class="n">path_incomplete</span><span class="p">,</span>
                            <span class="n">config</span><span class="o">.</span><span class="n">path_states</span><span class="p">,</span>
                            <span class="n">config</span><span class="o">.</span><span class="n">path_scratch</span><span class="p">,</span>
                            <span class="n">config</span><span class="o">.</span><span class="n">kdb_name</span><span class="p">,</span>
                            <span class="n">config</span><span class="o">.</span><span class="n">kdb_scratch_path</span><span class="p">,</span>
                            <span class="n">config</span><span class="o">.</span><span class="n">sb_path</span><span class="p">,</span>
                            <span class="n">config</span><span class="o">.</span><span class="n">sb_recycling_path</span><span class="p">,</span>
                            <span class="n">config</span><span class="o">.</span><span class="n">debug_results_path</span><span class="p">,</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="s2">&quot;searchdata&quot;</span><span class="p">),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="s2">&quot;askmc_data.txt&quot;</span><span class="p">),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="s2">&quot;searches.log&quot;</span><span class="p">),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="s2">&quot;dynamics.txt&quot;</span><span class="p">),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="s2">&quot;info.txt&quot;</span><span class="p">),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="s2">&quot;akmc.log&quot;</span><span class="p">),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="s2">&quot;jobs.tbl&quot;</span><span class="p">),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="s2">&quot;results&quot;</span><span class="p">),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="s2">&quot;prng.pkl&quot;</span><span class="p">),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="s2">&quot;explorer.pickle&quot;</span><span class="p">),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="s2">&quot;temperatures.dat&quot;</span><span class="p">),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="s2">&quot;client.log&quot;</span><span class="p">),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="s2">&quot;lockfile&quot;</span><span class="p">),</span>
                            <span class="p">]</span>
                <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">rmthings</span><span class="p">:</span>
                    <span class="n">attempt_removal</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reset&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not resetting&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">restart</span><span class="p">:</span>
        <span class="n">string_sb_clear</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Are you sure you want to restart (remove dynamics.txt, info.txt and akmc.log)? (y/N) &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>

            <span class="c1"># remove akmc data that are specific for a trajectory</span>
            <span class="n">dynamics_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="s2">&quot;dynamics.txt&quot;</span><span class="p">)</span>
            <span class="n">info_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="s2">&quot;info.txt&quot;</span><span class="p">)</span>
            <span class="n">log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="s2">&quot;akmc.log&quot;</span><span class="p">)</span>
            <span class="n">jobs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="s2">&quot;jobs.tbl&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">info_path</span><span class="p">,</span> <span class="n">dynamics_path</span><span class="p">,</span> <span class="n">log_path</span><span class="p">,</span> <span class="n">jobs_path</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_on</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Should the superbasins be removed? (y/N) &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

                <span class="c1"># remove superbasin data (specific for a trajectory)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                    <span class="c1"># remove directory superbasins</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sb_path</span><span class="p">):</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sb_path</span><span class="p">)</span>
                        <span class="c1">#XXX: ugly way to remove all empty directories containing this one</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sb_path</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">removedirs</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sb_path</span><span class="p">)</span>

                    <span class="c1"># remove superbasins files from states dirctories</span>
                    <span class="n">state_dirs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_states</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">state_dirs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="s1">&#39;state_table&#39;</span><span class="p">:</span>
                            <span class="n">superbasin_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">path_states</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                            <span class="n">superbasin_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">superbasin_file</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">sb_state_file</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">superbasin_file</span><span class="p">):</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">superbasin_file</span><span class="p">)</span>

                    <span class="n">string_sb_clear</span> <span class="o">=</span> <span class="s2">&quot; with directory &#39;superbasins&#39; and files named &#39;&quot;</span>
                    <span class="n">string_sb_clear</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sb_state_file</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; removed&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Restart&quot;</span><span class="o">+</span><span class="n">string_sb_clear</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not restarting&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lock</span><span class="o">.</span><span class="n">aquirelock</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">continuous</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">comm_type</span> <span class="o">==</span> <span class="s1">&#39;mpi&#39;</span><span class="p">:</span>
            <span class="c1"># define a wait method.</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">comm_type</span> <span class="o">==</span> <span class="s1">&#39;mpi&#39;</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">eon.mpiwait</span><span class="w"> </span><span class="kn">import</span> <span class="n">mpiwait</span>
                <span class="n">wait</span> <span class="o">=</span> <span class="n">mpiwait</span>
            <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">continuous</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">comm_type</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
                    <span class="c1"># In local, everything is synchronous, so no need to wait here.</span>
                    <span class="n">wait</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wait</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">sleep</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;You have found a bug in EON!&quot;</span><span class="p">)</span>
            <span class="c1"># Run a specified number of steps or forever.</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">steps</span> <span class="o">=</span> <span class="n">akmc</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">akmc_max_kmc_steps</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                    <span class="n">steps</span> <span class="o">&gt;=</span> <span class="n">config</span><span class="o">.</span><span class="n">akmc_max_kmc_steps</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="n">wait</span><span class="p">()</span>
            <span class="c1"># In MPI mode we need to signal exit to all processes.</span>
            <span class="c1"># TODO: This is the sledgehammer method, it would be cleaner to</span>
            <span class="c1">#       communicate to all clients that they should exit.</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">comm_type</span> <span class="o">==</span> <span class="s1">&#39;mpi&#39;</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">mpi4py</span><span class="w"> </span><span class="kn">import</span> <span class="n">MPI</span>
                <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">Abort</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">akmc</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server is locked by pid </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">lock</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By the eOn developers
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2025, the eOn developers.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

<div
  style="
    text-align: center;
    font-size: 0.9em;
    color: var(--pst-color-muted, #6c757d);
  "
>
  
  <span
    style="
      display: inline-flex;
      align-items: center;
      gap: 0.3em;
      white-space: nowrap;
    "
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="1em"
      height="1em"
      viewBox="0 0 24 24"
      fill="currentColor"
      role="img"
      aria-hidden="true"
      style="vertical-align: middle"
    >
      <path
        d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"
      ></path>
    </svg>
    Hosted by
    <a href="https://www.netlify.com/" target="_blank" rel="noopener noreferrer"
      >Netlify</a
    >
  </span>

  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="1em"
    height="1em"
    viewBox="0 0 24 24"
    fill="currentColor"
    role="img"
    aria-hidden="true"
  >
    <path d="M7,20H4V4h3V20z M14,20h-3V12h3V20z M21,20h-3V8h3V20z" />
  </svg>
  <span style="white-space: nowrap">
    Analytics via
    <a href="https://plausible.io/" target="_blank" rel="noopener noreferrer"
      >Plausible</a
    >, provided by
  </span>

  <span
    style="
      display: inline-flex;
      align-items: center;
      gap: 0.3em;
      white-space: nowrap;
      margin-left: 0.4em;
    "
  >
    <span
      style="
        display: inline-flex;
        align-items: center;
        gap: 0.3em;
        white-space: nowrap;
        margin-left: 0.4em;
      "
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="1.2em"
        height="1.2em"
        viewBox="0 0 64 64"
        role="img"
        aria-hidden="true"
        style="vertical-align: middle"
      >
        <g fill-rule="evenodd">
          <ellipse cx="32" cy="11" fill="#80D25B" rx="7" ry="9" />
          <path
            fill="#80D25B"
            d="M20.302104,46 C20.302104,46 17.1330329,55.8812548 20.6828149,59.7817355 C24.232597,63.6822162 26.8008673,63.215359 26.8008673,53.7414927 C26.8008673,44.2676263 20.302104,46 20.302104,46 Z"
          />
          <path
            fill="#80D25B"
            d="M38.302104,46 C38.302104,46 35.1330329,55.8812548 38.6828149,59.7817355 C42.232597,63.6822162 44.8008673,63.215359 44.8008673,53.7414927 C44.8008673,44.2676263 38.302104,46 38.302104,46 Z"
            transform="matrix(-1 0 0 1 81.8 0)"
          />
          <path
            fill="#80D25B"
            d="M20.6227767,21.2218684 C20.6227767,21.2218684 13.956214,15.3844007 10.091955,16.0534044 C6.22769598,16.722408 6,22.2124633 6,23.9992899 C6,25.7861165 7.78917398,37.3159836 9.78726488,36.4967476 C11.7853558,35.6775115 13.7411938,27.959322 13.7411938,27.959322 C13.7411938,27.959322 15.6510232,30.2287702 18.609193,30.4630388"
          />
          <path
            fill="#80D25B"
            d="M57.6227767,21.2218684 C57.6227767,21.2218684 50.956214,15.3844007 47.091955,16.0534044 C43.227696,16.722408 43,22.2124633 43,23.9992899 C43,25.7861165 44.789174,37.3159836 46.7872649,36.4967476 C48.7853558,35.6775115 50.7411938,27.959322 50.7411938,27.959322 C50.7411938,27.959322 52.6510232,30.2287702 55.609193,30.4630388"
            transform="matrix(-1 0 0 1 100.623 0)"
          />
          <path
            fill="#BD7575"
            stroke="#595959"
            stroke-linecap="round"
            stroke-width="2"
            d="M32,53 C40.836556,53 48,44.4934102 48,34 C48,23.5065898 46.6814044,17 32,17 C17.3185956,17 16,23.5065898 16,34 C16,44.4934102 23.163444,53 32,53 Z"
          />
          <polygon
            fill="#BD7575"
            stroke="#595959"
            stroke-linecap="round"
            stroke-width="2"
            points="32 22 38.928 26 38.928 34 32 38 25.072 34 25.072 26"
          />
          <path
            stroke="#595959"
            stroke-linecap="round"
            stroke-width="2"
            d="M30,8 C28.8954305,8 28,8.8954305 28,10"
          />
          <path
            stroke="#595959"
            stroke-linecap="round"
            stroke-width="2"
            d="M36,8 C34.8954305,8 34,8.8954305 34,10"
            transform="matrix(-1 0 0 1 70 0)"
          />
          <path
            stroke="#595959"
            stroke-linecap="round"
            stroke-width="2"
            d="M32.1194396 38.1881507L32.1194396 52.4125899M32.0164956 21.7467197L32.0164956 17M25.2141026 26.0041506L17.737148 23.0721126M25.1254173 34.1534318L16.7659494 38.8876521"
          />
          <path
            stroke="#595959"
            stroke-linecap="round"
            stroke-width="2"
            d="M46.2141026,26.0041506 L38.737148,23.0721126"
            transform="matrix(-1 0 0 1 84.951 0)"
          />
          <path
            stroke="#595959"
            stroke-linecap="round"
            stroke-width="2"
            d="M47.1254173,34.1534318 L38.7659494,38.8876521"
            transform="matrix(-1 0 0 1 85.891 0)"
          />
        </g>
      </svg>
    </span>
    <a href="https://turtletech.us/" target="_blank" rel="noopener noreferrer"
      >TurtleTech ehf</a
    >
  </span>
</div>


<!------>

  <footer class="bd-footer">
  </footer>
<!------>

  </body>
</html>